<!--expense_list.html-->

<!DOCTYPE html>
<html lang="cs" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Seznam vÃ½dajÅ¯</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/styles.css}">

</head>
<body class="bg-gray-100 text-gray-900">

<!-- Navigace -->
<div th:replace="~{fragments/navbar :: navbar}"></div>


<div class="container mx-auto p-6">
    <div class="bg-white shadow-lg rounded-lg p-6">
        <h2 class="text-xl font-semibold mb-4">ğŸ“œ VÅ¡echny uloÅ¾enÃ© vÃ½daje</h2>

        <!-- Desktop tabulka -->
        <div class="overflow-x-auto w-full hidden md:block">
            <table class="table-auto w-full border-collapse border mt-4 text-left">
                <thead>
                <tr class="bg-gradient-to-r from-green-900 via-green-800 to-green-700 text-yellow-500">
                    <th>ğŸ‘¤ UÅ¾ivatel</th>
                    <th>ğŸ“† Rok</th>
                    <th>ğŸ“… MÄ›sÃ­c</th>
                    <th>âš¡ ElektÅ™ina</th>
                    <th>ğŸ”¥ Plyn</th>
                    <th>ğŸ  NÃ¡jem</th>
                    <th>ğŸš— Auto</th>
                    <th>â›½ BenzÃ­n</th>
                    <th>ğŸŒ Internet</th>
                    <th>ğŸ¥— Lunch</th>
                    <th>ğŸ›’ Shop</th>
                    <th>ğŸ“Š Celkem</th>
                    <th>ğŸ’° Fond</th>
                    <th>âš–ï¸ RozdÃ­l</th>
                    <th>Editovat/Smazat</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="expense, iter : ${expenses}"
                    th:class="${iter.odd} ? 'bg-gray-100' : 'bg-gray-300'"> <!-- ğŸŸ¢ StÅ™Ã­davÃ© barvy pro Å™Ã¡dky -->
                    <td th:text="${expense.user}"></td>
                    <td th:text="${expense.year}"></td>
                    <td th:text="${expense.month}"></td>
                    <td th:text="${expense.electricity}"></td>
                    <td th:text="${expense.gas}"></td>
                    <td th:text="${expense.rental}"></td>
                    <td th:text="${expense.car}"></td>
                    <td th:text="${expense.petrol}"></td>
                    <td th:text="${expense.internet}"></td>
                    <td th:text="${expense.lunch}"></td>

                    <!-- EDITOVAT SHOP -->
                    <td>
                        <a th:href="@{/expenses/shopping/edit/{id}(id=${expense.id})}"
                           class="text-blue-500 cursor-pointer">ğŸ›’ <span th:text="${expense.shoppingInStore}"></span>
                        </a>
                    </td>

                    <td th:text="${expense.totalSum}"></td>

                    <!-- EDITOVAT FOND -->
                    <td>
                        <a th:href="@{/expenses/expected_contribution/edit/{id}(id=${expense.id})}"
                           class="text-blue-500 cursor-pointer"><span
                                th:text="${expense.expectedContributions != null ? expense.getExpectedContributionSum() : 0}"></span>
                        </a>
                    </td>

                    <td th:text="${expense.balanceStatus != null ? expense.balanceStatus : 'NeznÃ¡mÃ½ stav'}"></td>

                    <td>
                        <a th:href="@{/expenses/edit/{id}(id=${expense.id})}"
                           class="bg-yellow-500 text-white px-3 py-1 rounded">ğŸ–Šï¸</a>
                        <form action="/expenses/removeUser" method="post" style="display:inline;">
                            <input type="hidden" name="id" th:value="${expense.id}">
                            <button type="submit" class="bg-red-600 text-white px-3 py-1 rounded">ğŸ—‘ï¸</button>
                        </form>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>


        <!-- MobilnÃ­ zobrazenÃ­ jako karty -->
        <div class="block md:hidden">
            <div th:each="expense : ${expenses}" class="border rounded-lg p-4 mb-4 shadow">
                <p><strong>ğŸ‘¤ UÅ¾ivatel:</strong> <span th:text="${expense.user}"></span></p>
                <p><strong>ğŸ“† Rok:</strong> <span th:text="${expense.year}"></span></p>
                <p><strong>ğŸ“… MÄ›sÃ­c:</strong> <span th:text="${expense.month}"></span></p>
                <p><strong>âš¡ ElektÅ™ina:</strong> <span th:text="${expense.electricity}"></span></p>
                <p><strong>ğŸ”¥ Plyn:</strong> <span th:text="${expense.gas}"></span></p>
                <p><strong>ğŸ  NÃ¡jem:</strong> <span th:text="${expense.rental}"></span></p>
                <p><strong>ğŸš— Auto:</strong> <span th:text="${expense.car}"></span></p>
                <p><strong>â›½ BenzÃ­n:</strong> <span th:text="${expense.petrol}"></span></p>
                <p><strong>ğŸŒ Internet:</strong> <span th:text="${expense.internet}"></span></p>
                <p><strong>ğŸ¥— Lunch:</strong> <span th:text="${expense.lunch}"></span></p>

                <!-- EDITOVAT SHOP -->
                <p><strong>ğŸ›’ Shop:</strong>
                    <a th:href="@{/expenses/shopping/edit/{id}(id=${expense.id})}"
                       class="text-blue-500 cursor-pointer">ğŸ›’ <span th:text="${expense.shoppingInStore}"></span>
                    </a>
                </p>

                <p><strong>ğŸ“Š Celkem:</strong> <span th:text="${expense.totalSum}"></span></p>

                <!-- EDITOVAT FOND -->
                <p><strong>ğŸ’° Fond:</strong>
                    <a th:href="@{/expenses/expected_contribution/edit/{id}(id=${expense.id})}"
                       class="text-blue-500 cursor-pointer"><span
                            th:text="${expense.expectedContributions != null ? expense.getExpectedContributionSum() : 0}"></span>
                    </a>
                </p>

                <p><strong>âš–ï¸ RozdÃ­l:</strong> <span
                        th:text="${expense.balanceStatus != null ? expense.balanceStatus : 'NeznÃ¡mÃ½ stav'}"></span></p>

                <!-- AkÄnÃ­ tlaÄÃ­tka -->
                <div class="flex space-x-2 mt-2">
                    <a th:href="@{/expenses/edit/{id}(id=${expense.id})}"
                       class="bg-yellow-500 text-white px-3 py-1 rounded">ğŸ–Šï¸ Editovat</a>
                    <form action="/expenses/removeUser" method="post">
                        <input type="hidden" name="id" th:value="${expense.id}">
                        <button type="submit" class="bg-red-600 text-white px-3 py-1 rounded">ğŸ—‘ï¸ Smazat</button>
                    </form>
                </div>
            </div>
        </div>


        <!-- MODAL OKNO PRO EDITACI OÄŒEKÃVANÃ‰HO PÅ˜ÃSPÄšVKU -->
        <div id="expectedContributionModal"
             class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center">
            <div class="bg-white p-6 rounded-lg shadow-lg w-96">
                <h2 class="text-xl font-semibold mb-4">ğŸ’° Nastavit pÅ™Ã­spÄ›vek</h2>
                <form id="expectedContributionForm" action="/expenses/expected_contribution/update" method="post">
                    <input type="hidden" id="expenseId" name="expenseId">
                    <input type="number" id="expectedContributionInput" name="expectedContribution"
                           placeholder="ÄŒÃ¡stka" required class="border p-2 w-full">
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded mt-4">ğŸ’¾ UloÅ¾it</button>
                </form>

                <button onclick="closeModal()" class="mt-4 bg-gray-500 text-white px-4 py-2 rounded w-full">ZavÅ™Ã­t
                </button>
            </div>

            <!-- ğŸ“Œ Skript pro modÃ¡lnÃ­ okno a AJAX -->
            <script>
                function openModal(expenseId, expectedContribution) {
                    console.log("ğŸ”¹ OtevÃ­rÃ¡m modal pro ID:", expenseId, "Hodnota:", expectedContribution);

                    let modal = document.getElementById("expectedContributionModal");
                    if (!modal) {
                        console.error("âŒ Chyba: Modal nebyl nalezen!");
                        return;
                    }

                    document.getElementById("expenseId").value = expenseId;
                    document.getElementById("expectedContributionInput").value = expectedContribution;
                    modal.classList.remove("hidden");
                }

                function closeModal() {
                    console.log("ğŸ”¹ ZavÃ­rÃ¡m modal!");
                    document.getElementById("expectedContributionModal").classList.add("hidden");
                }

                ////

                document.getElementById("expectedContributionForm").addEventListener("submit", function (event) {
                    event.preventDefault(); // ğŸš« ZabrÃ¡nÃ­ reloadu strÃ¡nky

                    let expenseId = document.getElementById("expenseId").value;
                    let newContribution = document.getElementById("expectedContributionInput").value;

                    fetch(this.action, {
                        method: "POST",
                        headers: {"Content-Type": "application/x-www-form-urlencoded"},
                        body: `expenseId=${expenseId}&expectedContribution=${newContribution}`
                    })
                        .then(response => response.json()) // ğŸ“Œ VracÃ­me JSON s aktualizovanÃ½mi daty
                        .then(data => {
                            console.log("âœ… AktualizovanÃ¡ data:", data);

                            // ğŸ“Œ OkamÅ¾itÃ¡ aktualizace v tabulce
                            let contributionElement = document.getElementById("expectedContribution-" + data.id);
                            if (contributionElement) {
                                contributionElement.innerText = data.expectedContribution + " KÄ";
                            }

                            // ğŸ“Œ Aktualizace rozdÃ­lu (balanceStatus)
                            let balanceElement = document.querySelector(`[data-expense-id="${data.id}"]`);
                            if (balanceElement) {
                                balanceElement.innerText = data.balanceStatus;
                            }

                            // ğŸ“Œ ZavÅ™enÃ­ modal okna
                            closeModal();
                        })
                        .catch(error => console.error("âŒ Chyba pÅ™i aktualizaci:", error));
                });
            </script>
        </div>
        </div>
        </div>
</body>
</html>
